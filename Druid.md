## Druid ##
### 什么是Druid? ###
Apache Druid（孵化）是一个数据存储，专为大型数据集上的高性能切片和骰子分析（“OLAP”式）而设计。 Druid最常用作为GUI分析应用程序提供动力的数据存储，或者用作需要快速聚合的高度并发API的后端。 Druid的常见应用领域包括：

- 点击流分析
- 网络流量分析
- 服务器指标存储
- 应用性能指标
- 数字营销分析
- 商业智能/ OLAP

Druid的主要特点是：

1. **列式存储格式**。 Druid使用面向列的存储，这意味着它只需要加载特定查询所需的精确列。 这为仅查看几列的查询提供了巨大的速度提升。 此外，每列都针对其特定数据类型进行了优化，支持快速扫描和聚合。
2. **可扩展的分布式系统**。 Druid通常部署在数十到数百台服务器的集群中，可以提供数百万条记录/秒的摄取率，保留数万亿条记录，以及亚秒级到几秒钟的查询延迟。
3. **大规模并行处理**。 Druid可以在整个集群中并行处理查询。
4. **实时或批量摄取**。 Druid可以实时摄取数据（摄取的数据可立即用于查询）或批量摄取。
5. **自愈，自平衡，易于操作**。 作为操作者，要将群集扩展或缩小，只需添加或删除服务器，群集将在后台自动重新平衡，无需任何停机时间。 如果任何Druid服务器发生故障，系统将自动绕过损坏路由，直到可以更换这些服务器。 Druid旨在全天候运行，无需任何原因计划停机，包括配置更改和软件更新。
6. **云本机，容错架构，不会丢失数据**。 一旦Druid摄取了您的数据，副本就会安全地存储在深层存储（通常是云存储，HDFS或共享文件系统）中。 即使每个Druid服务器都出现故障，您的数据也可以从深层存储中恢复。 对于仅影响少数Druid服务器的更有限的故障，复制可确保在系统恢复时仍可进行查询。
7. **用于快速过滤的索引**。 Druid使用CONCISE或Roaring压缩位图索引来创建索引，这些索引可以跨多个列进行快速过滤和搜索。
8. **近似算法**。 Druid包括用于近似计数 - 独特，近似排序以及近似直方图和分位数的计算的算法。 这些算法提供有限的内存使用，并且通常比精确计算快得多。 对于精度比速度更重要的情况，Druid还提供精确计数 - 独特且精确的排名。
9. **在摄取时自动汇总**。 Druid可选择在摄取时支持数据汇总。 此汇总部分预先汇总了您的数据，可以节省大量成本并提高性能。
### Druid使用场景 ###
如果您的用例符合以下几个描述符，Druid可能是一个不错的选择：

- 插入率非常高，但更新不常见。
- 您的大多数查询都是聚合和报告查询（“分组依据”查询）。您可能还有搜索和扫描查询。
- 您将查询延迟定位为100毫秒到几秒。
- 您的数据有一个时间组件（Druid包括与时间特别相关的优化和设计选择）。
- 您可能有多个表，但每个查询只能访问一个大的分布式表。查询可能会遇到多个较小的“查找”表。
- 您有高基数数据列（例如网址，用户ID），需要对它们进行快速计数和排名。
- 您希望从Kafka，HDFS，平面文件或对象存储（如Amazon S3）加载数据。

您可能不想使用Druid的情况包括：

- 您需要使用主键对现有记录进行低延迟更新。 Druid支持流式插入，但不支持流式更新（使用后台批处理作业进行更新）。
- 您正在构建一个脱机报告系统，其中查询延迟不是很重要。
- 你想做“大”连接（将一个大事实表连接到另一个大事实表）。

### Druid架构 ###
Druid拥有一个多进程，分布式架构，旨在实现云友好且易于操作。 每个Druid流程类型都可以独立配置和扩展，为您的群集提供最大的灵活性。 此设计还提供增强的容错能力：一个组件的中断不会立即影响其他组件。
#### 进程和服务器 ####
Druid有几种过程类型，简要描述如下：

- **协调器**进程管理群集上的数据可用性。
- **Overlord**进程控制数据提取工作负载的分配。
- **代理**进程处理来自外部客户端的查询。
- **路由器**进程是可选的进程，可以将请求路由到Broker，Coordinator和Overlords。
- **历史**进程存储可查询数据。
- **MiddleManager**进程负责提取数据。

Druid进程可以按照您喜欢的方式进行部署，但为了便于部署，我们建议将它们组织为三种服务器类型：主服务器，查询和数据。

- **Master**：运行协调员和Overlord流程，管理数据可用性和摄取。
- **查询**：运行代理和可选的路由器进程，处理来自外部客户端的查询。
- **数据**：运行历史和MiddleManager流程，执行提取工作负载并存储所有可查询数据。

#### 外部依赖 ####
除了内置的流程类型，Druid还有三个外部依赖项。 这些旨在能够利用现有的现有基础设施。
##### 深度存储 #####
每个Druid服务器都可以访问共享文件存储。 这通常是像S3或HDFS这样的分布式对象存储，或者是网络安装的文件系统。 

Druid使用它来存储已被摄入系统的任何数据。Druid仅将深度存储用作数据的备份，并将其作为在Druid进程之间在后台传输数据的一种方式。 要响应查询，历史进程不会从深层存储读取数据，而是在提供任何查询之前从其本地磁盘读取预取的段。 这意味着Druid在查询期间永远不需要访问深层存储，从而帮助它提供最佳的查询延迟。 这也意味着您必须在深度存储和跨计划加载的数据的历史进程中拥有足够的磁盘空间。

##### 元数据存储 #####
元数据存储保存各种共享系统元数据，例如段可用性信息和任务信息。 这通常是传统的RDBMS，如PostgreSQL或MySQL。

##### Zookeeper #####
用于内部服务发现，协调和领导者选举。

这种架构背后的想法是使Druid集群在生产中大规模运作变得简单。 例如，深度存储和元数据存储与集群其余部分的分离意味着Druid进程具有极大的容错能力：即使每个Druid服务器都出现故障，您仍然可以从存储在深存储中的数据和元数据重新启动集群。

#### 架构图 ####
下图显示了通过该架构，即使用建议的Master/查询/数据服务器组织，实现查询和数据流通。

![](https://druid.apache.org/docs/img/druid-architecture.png)

### 官方文档 ###
[https://druid.apache.org/docs/latest/tutorials/index.html](https://druid.apache.org/docs/latest/tutorials/index.html)